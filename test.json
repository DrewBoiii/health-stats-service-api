[
  {
    "_id": "d296362f-fe11-492d-baf0-0a7aeafa9b8a",
    "name": "COVID19",
    "countries": [
      {
        "_id": "23950dd3-c0aa-4a44-b573-ff9745988c94",
        "name": "Afghanistan"
      },
      {
        "_id": "23950dd3-c0aa-4a44-b573-ff9745988c94",
        "name": "Afghanistan"
      }
    ]
  }
]

db.providers.update(
  {
    _id: "d296362f-fe11-492d-baf0-0a7aeafa9b8a",
    "countries._id": {
      "$nin": ["23950dd3-c0aa-4a44-b573-ff9745988c91"]
    }
  },
  {
    $addToSet: {
      "countries": {
        $each: [ {_id: "23950dd3-c0aa-4a44-b573-ff9745988c91", name: "EEE"} ],
      }
    }
  }
)

db.comparators.aggregate([
  {
    $match: {
      _id: 'd296362f-fe11-492d-baf0-0a7aeafa9b8a',
    }
  },
  {
    $addFields: {
      totalFound: {
        $reduce: {
          input: '$countries',
          initialValue: 0,
          in: {
            $cond: [
              { $eq: ['$$this.id', {_id: "23950dd3-c0aa-4a44-b573-ff9745988c91", name: "USA"}.id] },
              { $sum: ['$$value', 1] },
              { $sum: ['$$value', 0] }
            ]
          },
        }
      }
    }
  },
  {
    $project: {
      countries: {
        $cond: [
          { $eq: ['$totalFound', 0 ] },
          {
            $concatArrays: ['$countries', [ {_id: "23950dd3-c0aa-4a44-b573-ff9745988c91", name: "USA"} ]]
          },
          '$countries',
        ],
      }
    }
  }
])
